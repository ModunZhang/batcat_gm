{%extends '../layouts/service.html'%}


{% block content %}
<div class="row">
    <h4 style="text-align: center">Send System Chat</h4>

    <form action="/service/send-system-chat" method="post" role="form" class="form-horizontal" id="send-system-chat">
        <input type="hidden" name="_csrf" value="{{csrf_token}}">

        <div class="form-group">
            <label for="game" class="col-sm-2 control-label">Game</label>

            <div class="col-sm-9">
                <select title='Choose a game' name="gameId" id="game" class="selectpicker">
                    {% for game in games %}
                    <option value="{{game._id}}">{{game.name}}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="content" class="col-sm-2 control-label">Chats</label>

            <div class="col-sm-9 chat-body" id="chat-body">
                <ul class="chat" id="chat-ul">

                </ul>
            </div>
        </div>
        <div class="form-group">
            <label for="content" class="col-sm-2 control-label">Content</label>

            <div class="col-sm-9">
                <input type="text" name="content" placeholder="Content" id="content" class="form-control">
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-2 col-sm-9">
                <button class="btn btn-primary" type="submit">Send</button>
                &nbsp; or &nbsp;
                <a href="/service/chat" class="show-login">Cancel</a>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
    var errorTemplate = '<div class="fade in alert alert-danger" id="error_messages_container""><button class="close" type="button" data-dismiss="alert">Ã—</button><ul id="error_messages"></ul></div>';
    var chatTemplate = '<li><div class="chat-content"><div><strong class="primary-font">^Name^</strong><small class="pull-right text-muted">^Server^  ^Time^</small></div><p>^Content^</p></div></li>';
    var showErrors = function(errors){
        $('#body_content').prepend(errorTemplate);
        for(var i = 0; i < errors.length; i++){
            $('#error_messages').append('<li>' + errors[i] + '</li>');
        }
    };
    var hideErrors = function(){
        $('#error_messages_container').remove();
    };

    $(function(){
        $('#game').on('change', function(){
            var gameId = this.value;
            var lastChatTime = 0;
            var getChats = function(){
                $.get('/service/get-global-chats', {gameId:gameId, time:lastChatTime}, function(resp){
                    if(resp.code === 500) return showErrors(resp.data);

                    var chats = resp.data;
                    for(var i = 0; i < chats.length; i++){
                        var chat = chats[i];
                        var content = chatTemplate.replace('^Name^', chat.allianceTag.length > 0 ? "[" + chat.allianceTag + "]" + chat.name : chat.name).replace('^Server^', chat.serverId).replace('^Time^', $.format.prettyDate(chat.time)).replace('^Content^', chat.text);
                        $('#chat-ul').append(content);
                    }
                    if(chats.length > 0){
                        lastChatTime = chats[chats.length - 1].time;
                        $('#chat-body').scrollTop($('#chat-body')[0].scrollHeight);
                    }
                })
            };
            getChats();
            setInterval(getChats, 1000);
        });
        $('#send-system-chat').ajaxForm(function(resp){
            hideErrors();
            if(resp.code === 500) showErrors(resp.data);
            else $('#content').val('');
        });
    })
</script>
{% endblock %}