{%extends '../layouts/service.html'%}


{% block content %}
<h4 style="text-align: center">Send System Chat</h4>

<form action="/service/send-system-chat" method="post" role="form" class="form-horizontal" id="send-system-chat">
    <input type="hidden" name="_csrf" value="{{csrf_token}}">

    <div class="form-group">
        <label for="game" class="col-sm-2 control-label">Game</label>

        <div class="col-sm-9">
            <select title='Choose a game' name="gameId" id="game" class="selectpicker">
                {% for game in games %}
                <option value="{{game._id}}">{{game.name}}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="form-group">
        <label for="content" class="col-sm-2 control-label">Chats</label>

        <div class="col-sm-9 chat-body" id="chat-body">
            <ul class="chat" id="chat-ul">

            </ul>
        </div>
    </div>
    <div class="form-group">
        <label for="content" class="col-sm-2 control-label">Content</label>

        <div class="col-sm-9">
            <input type="text" name="content" placeholder="Content" id="content" class="form-control">
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-offset-2 col-sm-9">
            <button class="btn btn-primary" type="submit">Send</button>
            &nbsp; or &nbsp;
            <a href="/service/chat" class="show-login">Cancel</a>
        </div>
    </div>
</form>
{% endblock %}

{% block foot %}
<script type="text/javascript">
    var chatOthersTemplate = '<li><div class="chat-content clearfix"><div class="header"><strong class="primary-font">^Name^</strong><small class="pull-right text-muted">^Server^,^Time^</small></div><p>^Content^</p></div></li>';
    var chatMineTemplate = '<li><div class="chat-content clearfix"><div class="header"><strong class="pull-right primary-font">^Name^</strong><small class="text-muted">^Time^</small></div><p>^Content^</p></div></li>';
    $(function(){
        var intervalId = null;
        $('#game').on('change', function(){
            clearInterval(intervalId);
            $('#chat-ul').empty();
            var gameId = this.value;
            var lastChatTime = 0;
            var getChats = function(){
                $.get('/service/get-global-chats', {gameId:gameId, time:lastChatTime}, function(resp){
                    if(resp.code === 500) return;
                    var chats = resp.data;
                    for(var i = 0; i < chats.length; i++){
                        var chat = chats[i];
                        var content = null;
                        if(chat.name === 'System'){
                            content = chatMineTemplate.replace('^Name^', chat.name).replace('^Server^', chat.serverId).replace('^Time^', $.format.prettyDate(chat.time)).replace('^Content^', chat.text);
                        }else{
                            content = chatOthersTemplate.replace('^Name^', chat.allianceTag.length > 0 ? "[" + chat.allianceTag + "]" + chat.name : chat.name).replace('^Server^', chat.serverId).replace('^Time^', $.format.prettyDate(chat.time)).replace('^Content^', chat.text);
                        }
                        $('#chat-ul').append(content);
                    }
                    if(chats.length > 0){
                        lastChatTime = chats[chats.length - 1].time;
                        $('#chat-body').scrollTop($('#chat-body')[0].scrollHeight);
                    }
                })
            };
            getChats();
            intervalId = setInterval(getChats, 1000);
        });
        $('#send-system-chat').ajaxForm(function(resp){
            if(resp.code === 500){
                new PNotify({
                    text:resp.data,
                    type:'error'
                });
            }else{
                $('#content').val('');
            }
        });
    })
</script>
{% endblock %}